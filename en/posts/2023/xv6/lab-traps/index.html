<!DOCTYPE html>
<html lang="en"><head>
<title>xv6: Lab 4 traps Notes</title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=5, user-scalable=5" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">



<meta property="og:title" content="xv6: Lab 4 traps Notes" />
<meta property="og:description" content="MIT 6.S081 Lab 4 traps" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://eimy.ink/en/posts/2023/xv6/lab-traps/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-28T18:43:10-04:00" />
<meta property="article:modified_time" content="2023-09-28T18:43:10-04:00" />





<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="xv6: Lab 4 traps Notes"/>
<meta name="twitter:description" content="MIT 6.S081 Lab 4 traps"/>











  




<link rel="icon" href="http://eimy.ink/favicons/favicon.ico">



      <script src="/js/toc.js"></script>
    
    <link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">

<link rel="stylesheet" href="/scss/dark-mode.min.1b8d756f5775440d933c9656c9e438b615102519cb3d0c904c91deeaea446782.css" integrity="sha256-G411b1d1RA2TPJZWyeQ4thUQJRnLPQyQTJHe6upEZ4I=" media="screen">


<link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Material+Icons">

















<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/noto-serif-sc@5.2.8/index.css">
<link rel="stylesheet" href="/css/custom-font.css">
<link rel="stylesheet" href="/css/custom-texture.css">


</head>
<body>
    	<div id="app"><div class="single-column-drawer-container" id="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                <a class="a-block drawer-menu-item false" href="/en/archives/">
                    Archive
                </a>
                
            
                
                
                
                <a class="a-block drawer-menu-item false" href="/en/categories/">
                    Categories
                </a>
                
            
                
                
                
                <a class="a-block drawer-menu-item false" href="/en/tags/">
                    Tags
                </a>
                
            
                
                
                
                <a class="a-block drawer-menu-item false" href="/en/search/">
                    Search
                </a>
                
            
                
                
                
                <a class="a-block drawer-menu-item false" href="/en/about/">
                    About
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#lab-4-traps-%e5%ae%9e%e9%aa%8c%e8%ae%b0%e5%bd%95" class="nav-lab-4-traps-实验记录">
									Lab 4 traps 实验记录
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#42-backtrace" class="nav-42-backtrace">
									4.2 Backtrace
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#1-%e8%a6%81%e6%b1%82" class="nav-1-要求">
									1 要求
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#2-%e5%ae%9e%e7%8e%b0" class="nav-2-实现">
									2 实现
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#3-reflection" class="nav-3-reflection">
									3 reflection
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#43-alarm" class="nav-43-alarm">
									4.3 Alarm
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#1-%e8%a6%81%e6%b1%82-1" class="nav-1-要求-1">
									1 要求
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#2-%e5%ae%9e%e7%8e%b0-1" class="nav-2-实现-1">
									2 实现
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#3-%e6%80%9d%e8%80%83" class="nav-3-思考">
									3 思考
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#grade" class="nav-grade">
									Grade
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div id="drawer-mask" v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav id="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div id="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a id="navTitle" class="navbar-brand" href="http://eimy.ink/en/">
            EIMY
        </a>
        
        <button type="button" class="nav-darkmode-toggle" id="darkModeToggleButton2">
            <i class="material-icons" id="darkModeToggleIcon2">
                dark_mode
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" id="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="http://eimy.ink/en/">
        <div class="single-column-header-title">EIMY</div>
        
        <div class="single-column-header-subtitle">The dots will connect.</div>
        

    </a>
</div>

            <div id="content">
                <div id="streamContainer" class="stream-container">

    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            

            <div class="post-head-wrapper-text-only"
                
            >
                <div class="post-title">
                    xv6: Lab 4 traps Notes
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2023-09-28 18:43
                        </time>
                        

                        
                            <i class="material-icons" style="">folder</i>
                                <a href="/en/categories/">[Notes]</a>
                                &nbsp;
                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/en/tags/operating-system">Operating System</a>
                                &nbsp;
                            
                        
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    <h1 id="lab-4-traps-实验记录">Lab 4 traps 实验记录</h1>
<p>课上的截图，对理解trap很有帮助：high-level picture of the procedure of switching from user mode to supervisor mode</p>
<p><img src="./assets/image-20230923151811134.png" alt="image-20230923151811134"></p>
<h2 id="42-backtrace">4.2 Backtrace</h2>
<h3 id="1-要求">1 要求</h3>
<p>实现backtrace()函数，打印当前stack中的函数调用位置</p>
<h3 id="2-实现">2 实现</h3>
<p>跟着hints一步步实现:</p>
<p>主要函数如下，除此以外还需要声明函数、在指定位置调用etc.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// kernel/printf.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">backtrace</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// // read the current frame pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">uint64</span> <span class="n">curfp</span> <span class="o">=</span> <span class="nf">r_fp</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">uint64</span> <span class="n">begin</span> <span class="o">=</span> <span class="nf">PGROUNDDOWN</span><span class="p">(</span><span class="n">curfp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">uint64</span> <span class="n">end</span> <span class="o">=</span> <span class="nf">PGROUNDUP</span><span class="p">(</span><span class="n">curfp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// while curfp still in range of stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">while</span><span class="p">(</span><span class="n">curfp</span> <span class="o">&gt;=</span> <span class="n">begin</span> <span class="o">&amp;&amp;</span> <span class="n">curfp</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// print frame
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">uint64</span> <span class="o">*</span><span class="p">)(</span><span class="n">curfp</span> <span class="o">-</span> <span class="mi">8</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// get prev fp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// be careful with pointers!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">curfp</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">uint64</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">curfp</span> <span class="o">-</span> <span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// also modified kernel/defs.h, kernel/riscv.h,
</span></span></span><span class="line"><span class="cl"><span class="c1">// kernel/sysproc.c
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="3-reflection">3 reflection</h3>
<p>循环里的逻辑是打印frame pointer - 8位置的return addr -&gt; 更新frame pointer为其指向的prev frame pointer -&gt; 循环直到超出范围。</p>
<p>唯一一个卡手点在pointer casting那里（可见我写C真的不熟练、）。</p>
<h2 id="43-alarm">4.3 Alarm</h2>
<h3 id="1-要求-1">1 要求</h3>
<p>通过实现两个syscall&ndash;<code>sigalarm(interval, handler)</code>和<code>sigreturn()</code>，实现对进程的定时警报。<code>sigalarm(interval, handler)</code>使得每隔intervel数量的硬件ticks，会触发一次handler函数来进行警报。</p>
<h3 id="2-实现-1">2 实现</h3>
<p>instruction里分了两部分。</p>
<p>第一部分先实现（sigalarm中初始化警报相关参数 -&gt; 在tick数量达到interval的要求时，触发第一次警报）。实现方法是在usertrap()（<code>kernel/trap.c</code>）中，在当前进程累计tick数达<code>interval</code>时，把<code>handler</code>装进trapframe的epc中。这样在返回user program时就会首先执行epc里的函数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// 先写sigalarm函数 初始化警报参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">uint64</span>
</span></span><span class="line"><span class="cl"><span class="nf">sys_sigalarm</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">interval</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">uint64</span> <span class="n">handler</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// get interval a0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span><span class="p">(</span><span class="nf">argint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interval</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">// get pointer to the handler function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span><span class="p">(</span><span class="nf">argaddr</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handler</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">// put it into the struc of myproc()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">myproc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">alarm_handler</span> <span class="o">=</span> <span class="n">handler</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">myproc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="n">interval</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// myproc()-&gt;numticks = 0;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">usertrap</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">which_dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// give up the CPU if this is a timer interrupt.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span><span class="p">(</span><span class="n">which_dev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span><span class="o">-&gt;</span><span class="n">numticks</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">numticks</span> <span class="o">==</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// save the current trapframe bf overwriting
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">p</span><span class="o">-&gt;</span><span class="n">tpcopy</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// put the handler func into the program counter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// user will exec this func after returning
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">p</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">epc</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">alarm_handler</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">yield</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">usertrapret</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>但这样直接写进epc会导致原epc被覆盖，同时许多原进程保存在寄存器的内容也会在执行handler函数时被覆盖，所以第二部分中要用sigreturn()来解决这个问题。instr里已经指定了sigreturn()的作用，它会在traphandler结束时被调用，专门用来恢复原进程内容。</p>
<p>关于怎么恢复原进程，lab instr里的推荐做法（似乎）是在覆盖epc前，保存相关的寄存器。根据riscv convention我猜测至少需要保存所有的argument/pointer/save reg以及几个特殊寄存器。</p>
<p>但这样好像有点麻烦，更加直接（？）的解决方式是覆盖前直接拷贝一份进程的trapframe放一边，再在需要恢复时拷回来。</p>
<p>第三部分（第三个test）要求handler在没有返回前，不可以再次被调用。这里稍微卡了下，后来发现只要用tick计数就可以控制：目前累计ticks在只有在达到<code>interval</code>时会触发<code>handler</code>，也就是说只要累计ticks没有被重置，handler就只会被触发一次。利用这点，我们只在<code>sigreturn</code>中重置累计ticks，这样就等同于“在调用sigreturn（即handler结束）之前，不会有再次调用发生“。</p>
<p>主要代码是这些：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// usertrap()中加一句
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">numticks</span> <span class="o">==</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// save the current trapframe bf overwriting
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">p</span><span class="o">-&gt;</span><span class="n">tpcopy</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="p">);</span> <span class="c1">// +++++++tpcopy是在proc.h中声明的新参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">      <span class="c1">// put the handler func into the program counter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// user will exec this func after returning
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">p</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">epc</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">alarm_handler</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">uint64</span>
</span></span><span class="line"><span class="cl"><span class="nf">sys_sigreturn</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 把trapframe恢复成进入handler前的样子
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="p">(</span><span class="nf">myproc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="p">)</span> <span class="o">=</span> <span class="nf">myproc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">tpcopy</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 重置计数器 由此只有当一次handler call结束后才可能有下一次alarm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">myproc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">numticks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其他还有一堆syscall声明相关的修改，跟之前的syscall lab差不多。</p>
<h3 id="3-思考">3 思考</h3>
<p>这个task中最关键的是理解trap的流程和riscv中相关寄存器的作用。</p>
<h2 id="grade">Grade</h2>
<p><img src="./assets/image-20230928115904404.png" alt="image-20230928115904404"></p>

                    
                    <HR width="100%" id="EOF">
		    <p style="color:#777;">Last modified on 2023-09-28</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts" href="/en/posts/2023/xv6/lab-lazy/">
			Next<br>xv6: Lab 5 lazy Notes
                </a>
                
                
                
                <a class="older-posts" href="/en/posts/2023/xv6/lab-pgtbl/">
			Previous<br>xv6: Lab 3 pgtbl Notes
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                












            </div>
        </div>
    </div>


                    </div>
            </div><div id="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="http://eimy.ink/en/">
    
        <div class="nav-title">
            EIMY
        </div>
        
        <div class="nav-subtitle">
            The dots will connect.
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
            <a class="a-block nav-link-item false" href="/en/archives/">
                Archive
            </a>
            
        
            
            
            
            <a class="a-block nav-link-item false" href="/en/categories/">
                Categories
            </a>
            
        
            
            
            
            <a class="a-block nav-link-item false" href="/en/tags/">
                Tags
            </a>
            
        
            
            
            
            <a class="a-block nav-link-item false" href="/en/search/">
                Search
            </a>
            
        
            
            
            
            <a class="a-block nav-link-item false" href="/en/about/">
                About
            </a>
            
        
    </div>

    <div class="nav-footer">
        
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://risehere.net/">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	2026 EIMY
	

    </div>
</div>
<div id="extraContainer" class="extra-container">
    <div class="toc-wrapper">
        

        
        <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#lab-4-traps-%e5%ae%9e%e9%aa%8c%e8%ae%b0%e5%bd%95" class="nav-lab-4-traps-实验记录">
									Lab 4 traps 实验记录
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#42-backtrace" class="nav-42-backtrace">
									4.2 Backtrace
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#1-%e8%a6%81%e6%b1%82" class="nav-1-要求">
									1 要求
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#2-%e5%ae%9e%e7%8e%b0" class="nav-2-实现">
									2 实现
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#3-reflection" class="nav-3-reflection">
									3 reflection
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#43-alarm" class="nav-43-alarm">
									4.3 Alarm
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#1-%e8%a6%81%e6%b1%82-1" class="nav-1-要求-1">
									1 要求
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#2-%e5%ae%9e%e7%8e%b0-1" class="nav-2-实现-1">
									2 实现
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#3-%e6%80%9d%e8%80%83" class="nav-3-思考">
									3 思考
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#grade" class="nav-grade">
									Grade
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
        
    </div>
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top"
            :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a type="button" class="pagination-action" id="darkModeToggleButton">
            <span class="material-icons pagination-action-icon" id="darkModeToggleIcon">
                dark_mode
            </span>
        </a>
        
        
    </div>
</div>

<div id="single-column-footer">
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://risehere.net/">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	2026 EIMY
	
</div>
            </div>
    
    <script src="/js/journal.js"></script></body>
</html>
